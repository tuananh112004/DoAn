extends ../../layouts/default.pug
include ../../mixins/box-head.pug
include ../../mixins/alert.pug

block main
  div(data-product-id=product._id)
  script.
    console.log("Product ID in template:", "#{product._id}");
  +alert-success(2000)
  .product-detail
      .container.my-5
        .row
          .col-6
            .inner-thumb
              - const defaultThumbnail = 'http://res.cloudinary.com/darr5at86/image/upload/v1754289825/h8tbdd1ico5eztrmq0ev.png'
              img(src=(product.thumbnail || defaultThumbnail), alt=product.title)
          .col-6
            h1(class="inner-title") #{product.title}

            if (product.category)
              div(class="inner-category")
                span Danh mục: 
                a(href=`/products/${product.category.slug}`) #{product.category.title}

            if (product.priceNew)
              div(class="inner-price-new") #{product.priceNew}$

            if (product.price)
              div(class="inner-price-old") #{product.price}$

            if (product.discountPercentage)
              div(class="inner-percent") Giảm tới <span>#{product.discountPercentage}$</span>

            if (product.stock)
              div(class="inner-stock") Còn lại <span>#{product.stock}</span> sản phẩm

            form(
              action=`/cart/add/${product._id}`
              method="POST"
            )
              input(
                class="form-control mb-2"
                type="number"
                name="quantity"
                value="1"
                min="1"
                max=product.stock
              )
              button(
                type="submit"
                class="btn btn-success btn-block"
              ) Thêm vào giỏ hàng
      hr
      .container.my-5
        .row
          .col-12
            +box-head("Mô tả sản phẩm")
            .inner-desc !{product.description}
      
      //- Phần bình luận
      .container.my-5
        .row
          .col-12
            +box-head("Bình luận sản phẩm")
            
            //- Form tạo bình luận
            if user
              .comment-form.mb-4
                .card
                  .card-body
                    h5.card-title Viết bình luận
                    form#commentForm
                      .form-group.mb-3
                        label(for="rating") Đánh giá:
                        select#rating.form-control(name="rating")
                          option(value="5") ⭐⭐⭐⭐⭐ (5 sao)
                          option(value="4") ⭐⭐⭐⭐ (4 sao)
                          option(value="3") ⭐⭐⭐ (3 sao)
                          option(value="2") ⭐⭐ (2 sao)
                          option(value="1") ⭐ (1 sao)
                      .form-group.mb-3
                        label(for="commentContent") Nội dung bình luận:
                        textarea#commentContent.form-control(name="content" rows="3" placeholder="Viết bình luận của bạn..." required)
                      button.btn.btn-primary(type="submit") Gửi bình luận
            else
              .alert.alert-info
                | Vui lòng 
                a(href="/user/login") đăng nhập 
                | để viết bình luận
            
            //- Danh sách bình luận
            .comments-section
              #commentsList
                .text-center
                  .spinner-border(role="status")
                    span.sr-only Đang tải...
              
              //- Phân trang
              #commentsPagination.text-center.mt-4

block script
  if user
    script.
      window.currentUserId = "#{user._id}";
      console.log("Current user ID set:", window.currentUserId);
  else
    script.
      window.currentUserId = null;
      console.log("No user logged in");
